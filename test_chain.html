<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>팝콘처럼 호!</title>
    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        overflow: hidden;
        height: 100%;
        background: white;
        font-size: 18pt;
      }

      canvas {
        position: absolute;
        top: 0;
        left: 0;
        z-index: 0;
      }

      .letter {
        position: absolute;
        font-size: 80px;
        font-weight: bold;
        pointer-events: none;
        user-select: none;
        transform: translate(-50%, -50%);
        z-index: 10;
      }
    </style>
  </head>
  <body>
    <script src="https://cdn.jsdelivr.net/npm/matter-js@0.19.0/build/matter.min.js"></script>
    <script>
      const {
        Engine,
        Render,
        Runner,
        Bodies,
        Composite,
        Events,
        Mouse,
        MouseConstraint,
      } = Matter;

      const engine = Engine.create();
      const world = engine.world;

      const render = Render.create({
        element: document.body,
        engine: engine,
        options: {
          width: window.innerWidth,
          height: window.innerHeight,
          wireframes: false,
          background: "transparent",
        },
      });

      Render.run(render);
      const runner = Runner.create();
      Runner.run(runner, engine);

      // 바닥
      const ground = Bodies.rectangle(
        window.innerWidth / 2,
        window.innerHeight + 20,
        window.innerWidth,
        40,
        { isStatic: true }
      );
      Composite.add(world, ground);

      let hoCount = 0;
      let heyShown = false;

      // Hey 전용 카테고리
      const HEY_CATEGORY = 0x0002;

      function spawnHo(x, y) {
        const div = document.createElement("div");
        div.className = "letter";

        const colorOptions = [
          { color: "red", restitution: 1.0 },
          { color: "blue", restitution: 0.6 },
          { color: "green", restitution: 0.3 },
          { color: "orange", restitution: 0.8 },
          { color: "purple", restitution: 0.5 },
        ];
        const picked =
          colorOptions[Math.floor(Math.random() * colorOptions.length)];

        div.textContent = "호";
        div.style.color = picked.color;
        document.body.appendChild(div);

        const width = div.offsetWidth;
        const height = div.offsetHeight;

        const body = Bodies.rectangle(x, y, width, height, {
          restitution: picked.restitution,
          friction: 0.5,
          frictionAir: 0.01,
        });

        const forceX = (Math.random() - 0.5) * 0.2;
        const forceY = -Math.random() * 0.3 - 0.05;
        Matter.Body.applyForce(body, { x, y }, { x: forceX, y: forceY });

        body.domElement = div;
        Composite.add(world, body);
      }

      function showHeyText() {
        const hey = document.createElement("div");
        hey.className = "letter";
        hey.textContent = "Hey";
        hey.style.color = "black";
        document.body.appendChild(hey);

        const width = hey.offsetWidth;
        const height = hey.offsetHeight;

        const body = Bodies.rectangle(
          window.innerWidth / 2,
          window.innerHeight / 2,
          width,
          height,
          {
            isStatic: true,
            collisionFilter: {
              category: HEY_CATEGORY, // Hey만 드래그 가능
            },
          }
        );

        body.domElement = hey;
        Composite.add(world, body);

        // 이제서야 드래그 활성화
        const mouse = Mouse.create(render.canvas);
        const mouseConstraint = MouseConstraint.create(engine, {
          mouse: mouse,
          constraint: {
            stiffness: 0.2,
            render: { visible: false },
          },
          collisionFilter: {
            mask: HEY_CATEGORY, // 오직 HEY만 드래그 가능
          },
        });
        Composite.add(world, mouseConstraint);
        render.mouse = mouse;
      }

      window.addEventListener("click", (e) => {
        if (hoCount < 7) {
          spawnHo(e.clientX, e.clientY);
          hoCount++;

          if (hoCount === 7 && !heyShown) {
            showHeyText();
            heyShown = true;
          }
        }
      });

      Events.on(engine, "afterUpdate", () => {
        Composite.allBodies(world).forEach((body) => {
          if (body.domElement) {
            const { x, y } = body.position;
            body.domElement.style.left = `${x}px`;
            body.domElement.style.top = `${y}px`;
          }
        });
      });
    </script>
  </body>
</html>
