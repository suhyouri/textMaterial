<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>í…ìŠ¤íŠ¸ì˜ ë¬´ê²Œë¥¼ ê°ê°í•˜ê¸°</title>
    <style>
      html,
      body {
        display: flex;
        justify-content: center;
        align-items: center;
        margin: 0;
        padding: 0;
        height: 100%;
        overflow: hidden;
        background: white;
        font-family: "Noto Sans KR", sans-serif;
        font-size: 20px;
      }

      .progress-container {
        width: 10px; /* ì„¸ë¡œ ë°”ì´ê¸° ë•Œë¬¸ì— í­ì€ ì¢ê²Œ */
        height: 80vh; /* ì „ì²´ ë†’ì´ì˜ 30% ì •ë„, í•„ìš”ì‹œ ì¡°ì ˆ ê°€ëŠ¥ */
        background-color: white;
        border: 1px solid black;
        border-radius: 15px;
        box-sizing: border-box;
        position: fixed;
        bottom: 2%;
        left: 1%;
        z-index: 1;
        display: flex;
        align-items: flex-end; /* barê°€ ì•„ë˜ì—ì„œë¶€í„° ìœ„ë¡œ ìë¼ë„ë¡ */
      }

      .progress-bar {
        width: 100%;
        height: 0%; /* ì‹œì‘ì€ 0% */
        background-color: black;
        border-radius: 15px;
        transition: height 0.3s ease;
      }

      .title {
        position: fixed;
        top: 10px;
        left: 0;
        margin-left: 1%;
        font-weight: 500;
        text-align: left;
        /* background-color: white; */
        z-index: 999;
      }

      a {
        text-decoration: none; /* ë°‘ì¤„ ì œê±° */
        color: inherit; /* í…ìŠ¤íŠ¸ ìƒ‰ìƒì„ ë¶€ëª¨ ìš”ì†Œë¡œë¶€í„° ìƒì† */
      }

      .word {
        position: absolute;
        font-size: 1rem;
        font-weight: 500;
        pointer-events: none;
        user-select: none;
        /* background-color: white; */
        /* border: 2px solid black; */
        box-sizing: border-box;
        text-align: center;
        white-space: nowrap;
        z-index: 10;
        text-shadow: -1px -1px 0 white, 1px -1px 0 white, -1px 1px 0 white,
          1px 1px 0 white;
        transform: translate(-50%, -50%);
      }

      .circle {
        width: 50px;
        height: 50px;
        background-color: black;
        border-radius: 50%;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 9999;
        cursor: pointer;
        display: none;
        color: white;
        justify-content: center; /* âœ… ì¤‘ì•™ ì •ë ¬ (ê°€ë¡œ) */
        align-items: center;
      }

      canvas {
        position: absolute;
        top: 0;
        left: 0;
        pointer-events: none;
        z-index: 1;
      }

      .mobile-warning {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: yellow;
        color: black;
        font-family: "Noto Sans KR", sans-serif;
        font-size: 5vw;
        display: flex;
        justify-content: center;
        align-items: center;
        text-align: center;
        z-index: 99999;
        padding: 10%;
        box-sizing: border-box;
        line-height: 150%;
      }

      .score {
        position: fixed;
        top: 10px;
        right: 0;
        margin-right: 1%;
        font-weight: 500;
        text-align: right;
      }

      .consonant {
        /* border: 1px solid black; */
        display: inline-block;
        width: 1rem;
        margin-left: 0.1rem; /* â† ë¬¸ì¥ê³¼ì˜ ê°„ê²© ì¡°ì ˆ */
        text-align: center;
      }

      .consonantButton {
        margin-top: 0.5rem;
        width: 30%;
        font-size: 0.9rem;
        color: black;
        display: block; /* í•œ ì¤„ ì°¨ì§€ */
        padding: 0.3rem 0.8rem;
        background-color: white;
        transition: background-color 0.2s ease;
        text-align: center; /* ë‚´ë¶€ í…ìŠ¤íŠ¸ ì¤‘ì•™ ì •ë ¬ */
        cursor: pointer;
        border: 1px solid black;
        border-radius: 8px;
        margin-left: auto; /* ìš°ì¸¡ ì •ë ¬ */
      }

      .consonantButton:hover {
        background-color: #f0f0f0;
      }

      @keyframes shake {
        0% {
          transform: translate(-50%, -50%) rotate(0deg);
        }
        25% {
          transform: translate(-49%, -49%) rotate(5deg);
        }
        50% {
          transform: translate(-50%, -50%) rotate(0deg);
        }
        75% {
          transform: translate(-51%, -51%) rotate(-5deg);
        }
        100% {
          transform: translate(-50%, -50%) rotate(0deg);
        }
      }

      .shake-on-drag {
        animation: shake 0.15s infinite;
      }

      .word.draggable {
        pointer-events: auto; /* ìƒí˜¸ì‘ìš© ê°€ëŠ¥í•˜ê²Œ ì„¤ì • */
        cursor: grab; /* ë§ˆìš°ìŠ¤ ì»¤ì„œë¥¼ ì†ê°€ë½ ëª¨ì–‘ìœ¼ë¡œ */
      }

      @keyframes blink {
        0%,
        100% {
          opacity: 1; /* ì™„ì „íˆ ë³´ì„ */
        }
        50% {
          opacity: 0; /* ì™„ì „íˆ íˆ¬ëª… */
        }
      }

      .next.animate-blink {
        animation: blink 1s infinite alternate; /* 1ì´ˆ ë™ì•ˆ ë¬´í•œíˆ ê¹œë¹¡ì„ (ë‚˜íƒ€ë‚¬ë‹¤ ì‚¬ë¼ì¡Œë‹¤ ë°˜ë³µ) */
      }

      /* ğŸ’¡ ë°•ìˆ˜ ì´ëª¨í‹°ì½˜ CSS */
      .emoji {
        position: absolute;
        font-size: 2rem; /* ì´ëª¨í‹°ì½˜ í¬ê¸° */
        pointer-events: none; /* ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸ ë¬´ì‹œ */
        animation: pop 1s ease-out forwards; /* íŒ ì• ë‹ˆë©”ì´ì…˜ ì ìš© */
      }

      /* ğŸ’¡ íŒ ì• ë‹ˆë©”ì´ì…˜ í‚¤í”„ë ˆì„ */
      @keyframes pop {
        0% {
          transform: scale(0.5);
          opacity: 0;
        }
        50% {
          transform: scale(1.2);
          opacity: 1;
        }
        100% {
          transform: scale(1);
          opacity: 0;
        }
      }
    </style>
  </head>
  <body>
    <div class="title">
      í…ìŠ¤íŠ¸ì˜ ë¬´ê²Œë¥¼ ê°ê°í•˜ê¸°<br /><a
        href="https://www.instagram.com/suhyouri"
        target="_blank"
        rel="noopener noreferrer"
        >ì„œìœ ë¦¬</a
      >
      <br /><br />
      <div class="next" style="display: none">â–¶</div>
    </div>

    <div class="progress-container">
      <div class="progress-bar" id="progressBar"></div>
    </div>

    <div class="circle" id="circle">â†“</div>
    <div id="mobileWarning" class="mobile-warning" style="display: none">
      ë³¸ í”„ë¡œì íŠ¸ëŠ” <br />ë°ìŠ¤í¬íƒ‘ í™˜ê²½ì— ìµœì í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.<br />
      ë°ìŠ¤í¬íƒ‘ìœ¼ë¡œ ì ‘ì†í•´ì£¼ì„¸ìš”.
    </div>

    <div class="score">
      ë‹¤ìŒì˜ ììŒìœ¼ë¡œ ì‹œì‘í•˜ëŠ” ë¬¸ì¥ì„ ë§í•˜ì„¸ìš” :
      <div class="consonant">ã„±</div>
      <div class="consonantButton">ë‹¤ìŒ ììŒ â‡¢</div>
    </div>

    <div
      id="instructionDiv"
      style="
        position: fixed;
        left: 50%;
        top: 50%;
        width: 80%;
        transform: translate(-50%, -50%);
        font-size: 1rem;
        font-weight: 500;
        color: black;
        user-select: none;
        z-index: 99999;
        text-align: center;
        display: none; /* Hide initially */
      "
    >
      ë–¨ì–´ì§„ ê¸€ìë“¤ì„ ì£¼ì›Œ ì¢Œì¸¡ ìƒë‹¨ë¶€í„° ì°¨ë¡€ë¡œ ë°°ì—´í•˜ì„¸ìš”.
    </div>

    <script src="https://cdn.jsdelivr.net/npm/matter-js@0.19.0/build/matter.min.js"></script>

    <script>
      const SpeechRecognition =
        window.SpeechRecognition || window.webkitSpeechRecognition;
      const recognition = new SpeechRecognition();
      recognition.lang = "ko-KR";
      recognition.interimResults = false;
      recognition.continuous = true;

      let wordCount = 0;
      const maxWords = 5;
      const wordElements = [];

      // ğŸ’¡ ì´ ë¶€ë¶„ì— ì•„ë˜ ë³€ìˆ˜ë“¤ì„ ì¶”ê°€/ìˆ˜ì •í•˜ì„¸ìš”
      const matterBodies = []; // Matter.js ë°”ë””ì™€ DOM ìš”ì†Œë¥¼ ì €ì¥í•  ë°°ì—´

      let isDraggingWord = false; // ë‹¨ì–´ë¥¼ ë“œë˜ê·¸ ì¤‘ì¸ì§€ ì—¬ë¶€
      let currentDraggedBody = null; // í˜„ì¬ ë“œë˜ê·¸ ì¤‘ì¸ Matter.js ë°”ë””
      let currentDraggedElement = null; // í˜„ì¬ ë“œë˜ê·¸ ì¤‘ì¸ DOM ìš”ì†Œ
      let offsetX = 0; // ë“œë˜ê·¸ ì‹œì‘ ì‹œ ë§ˆìš°ìŠ¤ì™€ ìš”ì†Œ ì™¼ìª½ ìƒë‹¨ ê°„ì˜ X ì˜¤í”„ì…‹
      let offsetY = 0; // ë“œë˜ê·¸ ì‹œì‘ ì‹œ ë§ˆìš°ìŠ¤ì™€ ìš”ì†Œ ì™¼ìª½ ìƒë‹¨ ê°„ì˜ Y ì˜¤í”„ì…‹

      let gravityMode = false;
      let consonants = "ã„´ã„·ã„¹ã…ã…‚ã……ã…‡ã…ˆã…Šã…‹ã…ã…Œã…";
      let consonantIndex = -1;

      // ğŸ’¡ ìƒˆë¡œ ì¶”ê°€í•  ë³€ìˆ˜: ë“œë˜ê·¸ëœ ë‹¨ì–´ì˜ ê°œìˆ˜ë¥¼ ì„¸ëŠ” ì¹´ìš´í„°
      let draggedWordCount = 0;

      // ğŸ’¡ ìƒˆë¡œ ì¶”ê°€í•  ë³€ìˆ˜:
      let isErasingMode = false; // ë‹¨ì–´ ì§€ìš°ê¸° ëª¨ë“œì¸ì§€ ì—¬ë¶€
      let currentWordIndexToErase = 0; // ì§€ì›Œì•¼ í•  ë‹¨ì–´ì˜ í˜„ì¬ ì¸ë±ìŠ¤

      // ğŸ’¡ ìƒˆë¡œ ì¶”ê°€í•  ë³€ìˆ˜:
      const MAX_ATTEMPTS = 3; // ìµœëŒ€ ì‹œë„ íšŸìˆ˜
      let currentWordAttemptCount = 0; // í˜„ì¬ ë‹¨ì–´ì— ëŒ€í•œ ì‹œë„ íšŸìˆ˜

      // ğŸ’¡ ì´ ë¶€ë¶„ì„ ê¸°ì¡´ì˜ mousemove ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆì™€ êµì²´í•˜ì„¸ìš”
      document.addEventListener("mousemove", (e) => {
        if (isDraggingWord && currentDraggedElement && currentDraggedBody) {
          // DOM ìš”ì†Œ ìœ„ì¹˜ ì§ì ‘ ì—…ë°ì´íŠ¸ (left, top)
          currentDraggedElement.style.left = `${e.clientX - offsetX}px`;
          currentDraggedElement.style.top = `${e.clientY - offsetY}px`;

          // Matter.js ë°”ë”” ìœ„ì¹˜ë„ DOM ìš”ì†Œì— ë§ì¶° ì—…ë°ì´íŠ¸
          Matter.Body.setPosition(currentDraggedBody, {
            x: e.clientX - offsetX + currentDraggedElement.offsetWidth / 2,
            y: e.clientY - offsetY + currentDraggedElement.offsetHeight / 2,
          });
          // ğŸ’¡ currentDraggedElement.style.transformì€ ì—¬ê¸°ì„œ ì§ì ‘ ì¡°ì‘í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
          // shake-on-drag í´ë˜ìŠ¤ê°€ ë¶™ì–´ìˆìœ¼ë¯€ë¡œ CSS ì• ë‹ˆë©”ì´ì…˜ì´ transformì„ ì œì–´í•©ë‹ˆë‹¤.
        }
      });

      // ğŸ’¡ mouseup ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë‚´ë¶€
      // ğŸ’¡ mouseup ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë‚´ë¶€ ìˆ˜ì •:
      document.addEventListener("mouseup", () => {
        if (isDraggingWord && currentDraggedElement && currentDraggedBody) {
          isDraggingWord = false;
          currentDraggedElement.style.cursor = "grab";
          currentDraggedElement.classList.remove("shake-on-drag");

          currentDraggedElement.style.transform = `translate(-50%, -50%)`; // ê¸°ë³¸ transform ìœ ì§€

          Matter.Body.setStatic(currentDraggedBody, true);

          const draggedItem = matterBodies.find(
            (item) => item.body === currentDraggedBody
          );
          if (draggedItem) {
            // ë“œë˜ê·¸ëœ ì•„ì´í…œì„ ì°¾ì•˜ì„ ë•Œë§Œ
            // ğŸ’¡ ì—¬ê¸°ì—ì„œ ìµœì¢… ìœ„ì¹˜ë¥¼ ì €ì¥í•©ë‹ˆë‹¤.
            draggedItem.finalX =
              currentDraggedElement.offsetLeft +
              currentDraggedElement.offsetWidth / 2;
            draggedItem.finalY =
              currentDraggedElement.offsetTop +
              currentDraggedElement.offsetHeight / 2;

            if (!draggedItem.isDragged) {
              // í•œ ë²ˆë„ ë“œë˜ê·¸ë˜ì§€ ì•Šì€ ê²½ìš°ì—ë§Œ ì¹´ìš´íŠ¸ ì¦ê°€
              draggedItem.isDragged = true;
              draggedWordCount++;
            }

            if (draggedWordCount === matterBodies.length) {
              console.log("ëª¨ë“  ë‹¨ì–´ê°€ í•œ ë²ˆ ì´ìƒ ë“œë˜ê·¸ë˜ì—ˆìŠµë‹ˆë‹¤!");
              // ğŸ’¡ ì´ ì‹œì ì—ì„œ ë‹¨ì–´ë¥¼ ì •ë ¬í•©ë‹ˆë‹¤.
              sortWordsByPosition(); // ìƒˆë¡œìš´ í•¨ìˆ˜ í˜¸ì¶œ
              revealAllWords();
              document.querySelector(".next").classList.add("animate-blink");
            }
          }

          currentDraggedBody = null;
          currentDraggedElement = null;
        }
      });

      // ğŸ’¡ ìƒˆë¡œ ì¶”ê°€í•  í•¨ìˆ˜:
      function sortWordsByPosition() {
        // Y ì¢Œí‘œ(ìˆ˜ì§ ìœ„ì¹˜)ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë¨¼ì € ì •ë ¬í•˜ê³ , Y ì¢Œí‘œê°€ ë¹„ìŠ·í•˜ë©´ X ì¢Œí‘œ(ìˆ˜í‰ ìœ„ì¹˜)ë¡œ ì •ë ¬
        matterBodies.sort((a, b) => {
          // Y ì¢Œí‘œ ì°¨ì´ê°€ ì¼ì • ì„ê³„ê°’ ì´í•˜ë©´ ê°™ì€ ì¤„ë¡œ ê°„ì£¼
          const Y_THRESHOLD = 30; // í”½ì…€ ë‹¨ìœ„ë¡œ ì¡°ì ˆ
          if (Math.abs(a.finalY - b.finalY) < Y_THRESHOLD) {
            // ê°™ì€ ì¤„ë¡œ ê°„ì£¼, X ì¢Œí‘œë¡œ ì •ë ¬
            return a.finalX - b.finalX;
          }
          // ë‹¤ë¥¸ ì¤„ì´ë©´ Y ì¢Œí‘œë¡œ ì •ë ¬
          return a.finalY - b.finalY;
        });

        console.log(
          "ì •ë ¬ëœ ë‹¨ì–´ ìˆœì„œ:",
          matterBodies.map((item) => item.word)
        );
      }

      document
        .querySelector(".consonantButton")
        .addEventListener("click", () => {
          consonantIndex++;

          if (consonantIndex >= consonants.length) {
            // ììŒ ëë‚¬ìœ¼ë©´ ìš”ì†Œ ìˆ¨ê¸°ê¸°
            document.querySelector(".consonant").style.display = "none";
            document.querySelector(".consonantButton").style.display = "none";
            document.querySelector(".score").style.display = "none";
          } else {
            document.querySelector(".consonant").textContent =
              consonants[consonantIndex];
          }
        });

      function showWord(word) {
        const x = Math.random() * (window.innerWidth - 100);
        const y = Math.random() * (window.innerHeight - 30) + 40;

        if (!gravityMode) {
          const span = document.createElement("span");
          span.className = "word";
          span.textContent = word;
          span.style.left = `${x}px`;
          span.style.top = `${y}px`;
          document.body.appendChild(span);

          wordElements.push({ element: span, word });

          wordCount++;
          if (wordCount <= maxWords) {
            const progress = (wordCount / maxWords) * 100;
            document.getElementById(
              "progressBar"
            ).style.height = `${progress}%`;
          }

          if (wordCount === maxWords) {
            document.getElementById("circle").style.display = "block";
            document.getElementById("circle").style.display = "flex"; // Ensure it's flex for content centering
          }
        }
      }

      recognition.onresult = (event) => {
        const transcript =
          event.results[event.results.length - 1][0].transcript;
        // const words = transcript.trim().split(/\s+/); // ì´ ë³€ìˆ˜ëŠ” í˜„ì¬ ì‚¬ìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

        if (!isErasingMode) {
          // ê¸°ì¡´ ë‹¨ì–´ ìƒì„± ë¡œì§
          transcript.trim().split(/\s+/).forEach(showWord);
        } else {
          // ë‹¨ì–´ ì§€ìš°ê¸° ëª¨ë“œ
          const recognizedPhrase = transcript.trim();
          console.log("ì¸ì‹ëœ ë¬¸êµ¬ (ì§€ìš°ê¸° ëª¨ë“œ):", recognizedPhrase);

          if (currentWordIndexToErase < matterBodies.length) {
            const targetWordItem = matterBodies[currentWordIndexToErase];
            const targetWord = targetWordItem.word;

            // ì¸ì‹ëœ ë¬¸êµ¬ê°€ ì§€ì›Œì•¼ í•  ë‹¨ì–´ë¥¼ í¬í•¨í•˜ëŠ”ì§€ í™•ì¸
            if (recognizedPhrase.includes(targetWord)) {
              console.log(`'${targetWord}' ë‹¨ì–´ë¥¼ ì¸ì‹í–ˆìŠµë‹ˆë‹¤. ì œê±°í•©ë‹ˆë‹¤.`);
              // ë‹¨ì–´ ì œê±° ë° ë‹¤ìŒ ë‹¨ì–´ë¡œ ì´ë™
              removeCurrentWordAndAdvance();
              // ğŸ’¡ ì„±ê³µí–ˆìœ¼ë¯€ë¡œ ì‹œë„ íšŸìˆ˜ ì´ˆê¸°í™”
              currentWordAttemptCount = 0;
            } else {
              // ğŸ’¡ ì¸ì‹ ì‹¤íŒ¨ ì‹œ ì‹œë„ íšŸìˆ˜ ì¦ê°€
              currentWordAttemptCount++;
              console.log(
                `'${targetWord}'(ì„)ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”. (ì‹œë„ ${currentWordAttemptCount}/${MAX_ATTEMPTS})`
              );

              if (currentWordAttemptCount >= MAX_ATTEMPTS) {
                console.log(
                  `3ë²ˆ ì‹œë„ ì‹¤íŒ¨. '${targetWord}' ë‹¨ì–´ë¥¼ ìë™ìœ¼ë¡œ ì œê±°í•©ë‹ˆë‹¤.`
                );
                // ğŸ’¡ ì‹œë„ íšŸìˆ˜ ì´ˆê³¼ ì‹œ ê°•ì œ ì œê±° ë° ë‹¤ìŒ ë‹¨ì–´ë¡œ ì´ë™
                removeCurrentWordAndAdvance();
                // ğŸ’¡ ê°•ì œ ì œê±° í›„ì—ë„ ì‹œë„ íšŸìˆ˜ ì´ˆê¸°í™”
                currentWordAttemptCount = 0;
              }
            }
          }
        }
      };

      recognition.onerror = (event) => {
        console.error("Speech recognition error:", event.error);
      };

      recognition.onend = () => {
        // ğŸ’¡ isErasingModeì¼ ë•Œë„ ê³„ì† ì¸ì‹í•˜ë„ë¡ í•©ë‹ˆë‹¤.
        if (!gravityMode || isErasingMode) {
          recognition.start();
        }
      };

      recognition.start();

      const { Engine, Render, Runner, Bodies, Composite, Events } = Matter;
      const engine = Engine.create();
      const world = engine.world;

      const render = Render.create({
        element: document.body,
        engine: engine,
        options: {
          width: window.innerWidth,
          height: window.innerHeight,
          wireframes: false,
          background: "transparent",
        },
      });

      Render.run(render);
      const runner = Runner.create();
      Runner.run(runner, engine);

      const ground = Bodies.rectangle(
        window.innerWidth / 2,
        window.innerHeight + 20,
        window.innerWidth,
        40,
        { isStatic: true, render: { fillStyle: "gray" } } // Add this line
      );
      Composite.add(world, ground);
      // ì¶”ê°€

      const thickness = 40; // ë²½ ë‘ê»˜

      const leftWall = Bodies.rectangle(
        -thickness / 2, // x ìœ„ì¹˜: ì™¼ìª½ ë°”ê¹¥
        window.innerHeight / 2, // y ìœ„ì¹˜: í™”ë©´ ì¤‘ì•™
        thickness, // í­
        window.innerHeight, // ë†’ì´
        { isStatic: true, render: { fillStyle: "gray" } } // Add this line
      );

      const rightWall = Bodies.rectangle(
        window.innerWidth + thickness / 2, // x ìœ„ì¹˜: ì˜¤ë¥¸ìª½ ë°”ê¹¥
        window.innerHeight / 2,
        thickness,
        window.innerHeight,
        { isStatic: true, render: { fillStyle: "gray" } } // Add this line
      );

      Composite.add(world, [leftWall, rightWall]);

      Events.on(engine, "afterUpdate", () => {
        // ğŸ’¡ ì—­ìˆœìœ¼ë¡œ ìˆœíšŒí•˜ì—¬ ë°°ì—´ì—ì„œ ìš”ì†Œë¥¼ ì•ˆì „í•˜ê²Œ ì œê±°í•©ë‹ˆë‹¤.
        for (let i = matterBodies.length - 1; i >= 0; i--) {
          const { body, domElement } = matterBodies[i];
          const { x, y } = body.position;
          const angle = body.angle;

          // DOM ìš”ì†Œì˜ left, topì„ Matter.js ë°”ë””ì˜ ì¤‘ì‹¬ ìœ„ì¹˜ì— ë§ì¶¥ë‹ˆë‹¤.
          // CSSì— transform: translate(-50%, -50%)ê°€ ìˆìœ¼ë¯€ë¡œ,
          // domElementì˜ (x, y)ê°€ ê³§ ë°”ë””ì˜ ì¤‘ì‹¬ì´ ë©ë‹ˆë‹¤.
          domElement.style.left = `${x}px`;
          domElement.style.top = `${y}px`;

          // 'shake-on-drag' í´ë˜ìŠ¤ê°€ ì—†ìœ¼ë©´ Matter.jsì˜ íšŒì „ê°’ì„ ì ìš©í•©ë‹ˆë‹¤.
          // ì´ í´ë˜ìŠ¤ê°€ ìˆë‹¤ë©´ CSS ì• ë‹ˆë©”ì´ì…˜ì´ transformì˜ rotate ë¶€ë¶„ì„ ì œì–´í•©ë‹ˆë‹¤.
          if (!domElement.classList.contains("shake-on-drag")) {
            domElement.style.transform = `translate(-50%, -50%) rotate(${angle}rad)`;
          }

          // ğŸ’¡ ìŠ¤í¬ë¦° ë°–ìœ¼ë¡œ ë²—ì–´ë‚œ ìš”ì†Œ ì œê±° ë¡œì§
          // ë°”ë””ì˜ í•˜ë‹¨ ê²½ê³„ê°€ í™”ë©´ ì•„ë˜ë¡œ ì™„ì „íˆ ë²—ì–´ë‚˜ê±°ë‚˜,
          // ì¢Œìš° ê²½ê³„ê°€ í™”ë©´ ë°–ìœ¼ë¡œ ì™„ì „íˆ ë²—ì–´ë‚¬ì„ ë•Œ
          const buffer = 50; // í™”ë©´ ê²½ê³„ ë°–ìœ¼ë¡œ ì–¼ë§ˆë§Œí¼ ë” ë‚˜ê°€ì•¼ ì§€ìš¸ì§€ ì—¬ìœ ê°’ (px)

          if (
            gravityMode &&
            (body.bounds.min.y > window.innerHeight + buffer || // í™”ë©´ ì•„ë˜ë¡œ ë²—ì–´ë‚¨
              body.bounds.max.x < -buffer || // í™”ë©´ ì™¼ìª½ìœ¼ë¡œ ë²—ì–´ë‚¨
              body.bounds.min.x > window.innerWidth + buffer)
          ) {
            // í™”ë©´ ì˜¤ë¥¸ìª½ìœ¼ë¡œ ë²—ì–´ë‚¨

            console.log(
              `'${matterBodies[i].word}' ë‹¨ì–´ê°€ í™”ë©´ ë°–ìœ¼ë¡œ ë²—ì–´ë‚˜ ì œê±°ë©ë‹ˆë‹¤.`
            );

            // Matter.js ì›”ë“œì—ì„œ ë°”ë”” ì œê±°
            Matter.Composite.remove(world, body);
            // DOMì—ì„œ ìš”ì†Œ ì œê±°
            domElement.remove();

            // matterBodies ë°°ì—´ì—ì„œ í•´ë‹¹ ìš”ì†Œ ì œê±°
            matterBodies.splice(i, 1);

            // ğŸ’¡ ì¤‘ìš”: ë“œë˜ê·¸ëœ ë‹¨ì–´ ìˆ˜(draggedWordCount)ëŠ” ì´ ë¡œì§ì—ì„œ ì¤„ì´ì§€ ì•ŠìŠµë‹ˆë‹¤.
            // ì´ ë¡œì§ì€ í™”ë©´ ë°–ìœ¼ë¡œ ë‚˜ê°„ ê²ƒì„ ì§€ìš°ëŠ” ê²ƒì´ê³ ,
            // draggedWordCountëŠ” "í•œ ë²ˆ ì´ìƒ ë“œë˜ê·¸ë˜ì—ˆëŠ”ì§€" ì—¬ë¶€ë¥¼ ì¶”ì í•˜ê¸° ìœ„í•¨ì…ë‹ˆë‹¤.
            // ë”°ë¼ì„œ, matterBodies.lengthê°€ ë³€ê²½ë˜ë¯€ë¡œ,
            // ëª¨ë“  ë‹¨ì–´ê°€ ë“œë˜ê·¸ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ëŠ” ì¡°ê±´ (draggedWordCount === matterBodies.length)ì€
            // ì´ì œ 'ëª¨ë“  ì‚´ì•„ë‚¨ì€ ë‹¨ì–´'ê°€ ë“œë˜ê·¸ë˜ì—ˆëŠ”ì§€ë¡œ í•´ì„ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            // ë§Œì•½ 'ì›ë˜ ìƒì„±ëœ ëª¨ë“  ë‹¨ì–´'ê°€ ë“œë˜ê·¸ë˜ì–´ì•¼ í•œë‹¤ë©´, totalInitialWords ê°™ì€ ë³€ìˆ˜ê°€ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            // í˜„ì¬ ë¡œì§ì—ì„œëŠ” 'í˜„ì¬ ë‚¨ì•„ìˆëŠ” ë‹¨ì–´ë“¤' ì¤‘ì—ì„œ ë“œë˜ê·¸ëœ ìˆ˜ë¥¼ ì…‰ë‹ˆë‹¤.
          }
        }
      });

      document.getElementById("circle").addEventListener("click", () => {
        // âœ… ìŒì„±ì¸ì‹ ì •ì§€
        recognition.stop();

        gravityMode = true;
        document.querySelector(".score").style.display = "none";
        document.querySelector(".progress-container").style.display = "none";
        document.querySelector(".progress-bar").style.display = "none";

        wordElements.forEach(({ element, word }) => {
          const rect = element.getBoundingClientRect();
          element.remove();

          const width = rect.width;
          const height = rect.height;
          const x = rect.left + width / 2;
          const y = rect.top + height / 2;

          const body = Bodies.rectangle(x, y, width, height, {
            restitution: 0.9,
            friction: 0.1,
            frictionAir: 0.01, // ê³µê¸° ë§ˆì°° (íšŒì „ ê°ì†)
            angularDamping: 0.3, // íšŒì „ ê°ì‡ 
            density: word.length * 0.001 + 0.001,
            render: { visible: true, fillStyle: "black" }, // falseë¡œ í•˜ë©´ ë°•ìŠ¤ ì‚¬ë¼ë§‚ã…
          });

          //ìƒê²¨ë‚˜ëŠ” í…ìŠ¤íŠ¸ css ì •ë¦¬í•˜ê¸°
          const domBox = document.createElement("div");
          domBox.className = "word";
          domBox.style.width = `${width}px`;
          domBox.style.height = `${height}px`;
          domBox.style.lineHeight = `${height}px`;
          domBox.textContent = word;

          // domBox.style.backgroundColor = "black"; // DOM ìš”ì†Œ ë°°ê²½ìƒ‰ ê²€ì •ìƒ‰ìœ¼ë¡œ
          domBox.style.color = "transparent"; // í…ìŠ¤íŠ¸ ìƒ‰ìƒì„ í°ìƒ‰ìœ¼ë¡œ ë³€ê²½
          domBox.style.textShadow = "none"; // **ì´ ì¤„ì„ ì¶”ê°€í•˜ì—¬ text-shadow ì œê±°**

          document.body.appendChild(domBox);
          body.domElement = domBox;

          Composite.add(world, body);

          matterBodies.push({
            body,
            domElement: domBox,
            isDragged: false,
            word: word,
          });
        });

        document.getElementById("circle").remove();
        document.getElementById("instructionDiv").style.display = "block"; // ğŸ’¡ instructionDiv í‘œì‹œ

        // ğŸ’¡ 5ì´ˆ í›„ì— ë‹¨ì–´ë“¤ì„ ë“œë˜ê·¸ ê°€ëŠ¥í•˜ê²Œ ë§Œë“œëŠ” ë¡œì§
        setTimeout(() => {
          document.getElementById("instructionDiv").textContent =
            "ë–¨ì–´ì§„ ê¸€ìë“¤ì„ ì£¼ì›Œ ì¢Œì¸¡ ìƒë‹¨ë¶€í„° ì°¨ë¡€ë¡œ ë°°ì—´í•˜ì„¸ìš”."; // ì§€ì‹œë¬¸ ë³€ê²½
          // document.getElementById("instructionDiv").remove(); // ë˜ëŠ” ì§€ì‹œë¬¸ divë¥¼ ì œê±°í•˜ê³  ì‹¶ë‹¤ë©´ ì´ ì¤„ì„ í™œì„±í™”
          document.querySelector(".next").style.display = "block";
          matterBodies.forEach(({ body, domElement }) => {
            domElement.classList.add("draggable"); // CSS í´ë˜ìŠ¤ ì¶”ê°€ (ì»¤ì„œ ë³€ê²½ ìœ„í•¨)
            domElement.style.pointerEvents = "auto"; // ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸ í™œì„±í™”

            // ğŸ’¡ mousedown ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë‚´ë¶€
            domElement.addEventListener("mousedown", (e) => {
              isDraggingWord = true;
              currentDraggedBody = body;
              currentDraggedElement = domElement;

              const rect = currentDraggedElement.getBoundingClientRect();
              offsetX = e.clientX - rect.left;
              offsetY = e.clientY - rect.top;

              Matter.Body.setStatic(currentDraggedBody, true);

              currentDraggedElement.style.cursor = "grabbing";
              // ğŸ’¡ ì¶”ê°€: ë“œë˜ê·¸ ì‹œì‘ ì‹œ ê¸°ì¡´ transformì„ ì´ˆê¸°í™”í•˜ì—¬ ì• ë‹ˆë©”ì´ì…˜ì´ ê¹”ë”í•˜ê²Œ ì ìš©ë˜ë„ë¡ í•©ë‹ˆë‹¤.
              // ì´ë ‡ê²Œ í•˜ë©´ ì• ë‹ˆë©”ì´ì…˜ì´ 0% ìƒíƒœë¶€í„° ì‹œì‘í•©ë‹ˆë‹¤.
              currentDraggedElement.style.transform = ``; // ê¸°ì¡´ transformì„ ì™„ì „íˆ ì´ˆê¸°í™”

              currentDraggedElement.classList.add("shake-on-drag");
            });
          });
        }, 3000); // 3ì´ˆ ì§€ì—°
      });

      // ëª¨ë°”ì¼ í™˜ê²½ ê°ì§€ ë° ê²½ê³  í‘œì‹œ
      const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
      if (isMobile) {
        document.getElementById("mobileWarning").style.display = "flex";
      }

      function revealAllWords() {
        matterBodies.forEach(({ body, domElement }) => {
          if (body.render) {
            body.render.fillStyle = "rgba(0, 0, 0, 0)";
          }
          domElement.style.color = "black";
          domElement.style.backgroundColor = "transparent";
          domElement.classList.remove("draggable");
          domElement.style.pointerEvents = "none";
          domElement.style.cursor = "default";
        });

        document.querySelector(".next").classList.add("animate-blink");

        isErasingMode = true;
        recognition.start();

        document.getElementById("instructionDiv").textContent =
          "ì§€ì •ëœ ìˆœì„œëŒ€ë¡œ ë‹¨ì–´ë¥¼ ë§í•˜ì—¬ ì§€ìš°ì„¸ìš”.";

        // ğŸ’¡ ì‹œë„ íšŸìˆ˜ ì´ˆê¸°í™”
        currentWordAttemptCount = 0;

        if (matterBodies.length > 0) {
          matterBodies[0].domElement.style.textDecoration = "underline";
          matterBodies[0].domElement.style.fontWeight = "bold";
        }
      }

      // ğŸ’¡ ë°•ìˆ˜ ì¸ì‹ ì‹œì‘ í•¨ìˆ˜
      async function startClapDetector() {
        // ëª¨ë°”ì¼ í™˜ê²½ ê²½ê³  í‘œì‹œ ì¤‘ì´ë©´ ë°•ìˆ˜ ê°ì§€ê¸° ì‹œì‘ ì•ˆ í•¨
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        if (isMobile) {
          console.log("ëª¨ë°”ì¼ í™˜ê²½ì´ë¯€ë¡œ ë°•ìˆ˜ ê°ì§€ê¸°ë¥¼ ì‹œì‘í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
          return; // ëª¨ë°”ì¼ì´ë©´ í•¨ìˆ˜ ì‹¤í–‰ ì¤‘ë‹¨
        }

        try {
          const stream = await navigator.mediaDevices.getUserMedia({
            audio: true,
          });
          const audioCtx = new (window.AudioContext ||
            window.webkitAudioContext)();
          const mic = audioCtx.createMediaStreamSource(stream);
          const analyser = audioCtx.createAnalyser();
          const dataArray = new Uint8Array(analyser.fftSize);

          mic.connect(analyser);

          // ë³¼ë¥¨ ì„ê³„ê°’ (ì¡°ì ˆ ê°€ëŠ¥): ë°•ìˆ˜ë¥¼ ê°ì§€í•˜ëŠ” ë¯¼ê°ë„
          const CLAP_THRESHOLD = 60;

          function detectClap() {
            analyser.getByteTimeDomainData(dataArray);

            let maxVolume = 0;
            for (let i = 0; i < dataArray.length; i++) {
              const v = Math.abs(dataArray[i] - 128);
              if (v > maxVolume) maxVolume = v;
            }

            // console.log("Current max volume:", maxVolume); // ë””ë²„ê¹…ìš©: í˜„ì¬ ë³¼ë¥¨ í™•ì¸

            if (maxVolume > CLAP_THRESHOLD) {
              console.log("ë°•ìˆ˜ ê°ì§€! ğŸ‘");
              createClapEmoji();
            }

            requestAnimationFrame(detectClap);
          }

          function createClapEmoji() {
            const emoji = document.createElement("div");
            emoji.className = "emoji";
            emoji.textContent = "ğŸ‘";

            const x = Math.random() * (window.innerWidth - 50);
            const y = Math.random() * (window.innerHeight - 50);

            emoji.style.left = `${x}px`;
            emoji.style.top = `${y}px`;

            document.body.appendChild(emoji);

            setTimeout(() => {
              emoji.remove();
            }, 1000); // ì• ë‹ˆë©”ì´ì…˜ í›„ ì œê±°
          }

          detectClap();
          console.log("ë°•ìˆ˜ ê°ì§€ê¸° ì‹œì‘ë¨.");
        } catch (err) {
          console.error("ì˜¤ë””ì˜¤ ìŠ¤íŠ¸ë¦¼ì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤:", err);
          alert(
            "ë§ˆì´í¬ ì ‘ê·¼ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”."
          );
        }
      }

      // ğŸ’¡ ìƒˆë¡œ ì¶”ê°€í•  í•¨ìˆ˜: í˜„ì¬ ë‹¨ì–´ë¥¼ ì œê±°í•˜ê³  ë‹¤ìŒ ë‹¨ì–´ë¡œ ì§„í–‰
      function removeCurrentWordAndAdvance() {
        const targetWordItem = matterBodies[currentWordIndexToErase];

        // Matter.js ë°”ë”” ì œê±°
        Matter.Composite.remove(world, targetWordItem.body);
        // DOM ìš”ì†Œ ì œê±°
        targetWordItem.domElement.remove();

        // ì´ì „ ë‹¨ì–´ ê°•ì¡° í•´ì œ (ë§Œì•½ ì´ì „ ë‹¨ì–´ê°€ ì¡´ì¬í•œë‹¤ë©´)
        if (currentWordIndexToErase > 0) {
          matterBodies[
            currentWordIndexToErase - 1
          ].domElement.style.textDecoration = "none";
          matterBodies[
            currentWordIndexToErase - 1
          ].domElement.style.fontWeight = "normal";
        }

        // ë‹¤ìŒ ë‹¨ì–´ë¡œ ì¸ë±ìŠ¤ ì´ë™
        currentWordIndexToErase++;

        // ë‹¤ìŒ ë‹¨ì–´ ê°•ì¡° ë˜ëŠ” ëª¨ë“  ë‹¨ì–´ ì§€ì›€ ì²˜ë¦¬
        if (currentWordIndexToErase < matterBodies.length) {
          matterBodies[
            currentWordIndexToErase
          ].domElement.style.textDecoration = "underline";
          matterBodies[currentWordIndexToErase].domElement.style.fontWeight =
            "bold";
        } else {
          // ëª¨ë“  ë‹¨ì–´ë¥¼ ì§€ì› ì„ ë•Œ
          document.getElementById("instructionDiv").textContent =
            "ìˆ˜ê³ í•˜ì…¨ìŠµë‹ˆë‹¤!ğŸ‘ğŸ‘";
          recognition.stop();
          document.querySelector(".next").classList.remove("animate-blink");
          document.querySelector(".next").style.display = "none";

          // ğŸ’¡ ë°•ìˆ˜ ê°ì§€ê¸° ì‹œì‘!
          startClapDetector();
        }
      }
    </script>
  </body>
</html>
